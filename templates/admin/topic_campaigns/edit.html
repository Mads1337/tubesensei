{% extends "base.html" %}

{% block title %}Edit {{ campaign.name }} - TubeSensei Admin{% endblock %}

{% block page_title %}Edit Topic Campaign{% endblock %}
{% block page_description %}Update settings for {{ campaign.name }}{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <!-- Back Link -->
    <div class="mb-6">
        <a href="/admin/topic-campaigns/{{ campaign.id }}" class="text-sm text-gray-500 dark:text-gray-400 hover:text-primary-600">
            <i class="fas fa-arrow-left mr-1"></i> Back to Campaign
        </a>
    </div>

    <!-- Form Card -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <!-- Campaign Header -->
            <div class="flex items-center mb-6">
                <div class="flex-shrink-0 h-12 w-12 rounded-full bg-primary-100 dark:bg-primary-900 flex items-center justify-center mr-4">
                    <i class="fas fa-rocket text-primary-600 dark:text-primary-400"></i>
                </div>
                <div>
                    <h2 class="text-lg font-medium text-gray-900 dark:text-white">
                        Edit {{ campaign.name }}
                    </h2>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                        Status: <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if campaign.status.value == 'draft' %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300
                            {% elif campaign.status.value == 'failed' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300
                            {% else %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300{% endif %}">
                            {{ campaign.status.value|upper }}
                        </span>
                    </p>
                </div>
            </div>

            <form
                id="edit-campaign-form"
                hx-patch="/admin/topic-campaigns/{{ campaign.id }}"
                hx-indicator="#submit-indicator"
                class="space-y-6"
            >
                <!-- Basic Info -->
                <div class="space-y-4">
                    <h3 class="text-sm font-medium text-gray-900 dark:text-white uppercase tracking-wider">
                        Basic Information
                    </h3>

                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Campaign Name <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="text"
                            name="name"
                            id="name"
                            required
                            value="{{ campaign.name }}"
                            placeholder="e.g., YouTube Shorts Money Making"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                        >
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">A memorable name for this campaign</p>
                    </div>

                    <div>
                        <label for="topic" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Search Topic <span class="text-red-500">*</span>
                        </label>
                        <textarea
                            name="topic"
                            id="topic"
                            rows="2"
                            required
                            placeholder="e.g., how to make money creating YouTube shorts with AI"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                        >{{ campaign.topic }}</textarea>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">The topic to search for on YouTube. Be specific for better results.</p>
                    </div>

                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Description
                        </label>
                        <textarea
                            name="description"
                            id="description"
                            rows="3"
                            placeholder="Optional description of what you're looking for..."
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                        >{{ campaign.description or '' }}</textarea>
                    </div>
                </div>

                <!-- Configuration -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-6 space-y-4">
                    <h3 class="text-sm font-medium text-gray-900 dark:text-white uppercase tracking-wider">
                        Discovery Configuration
                    </h3>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="total_video_limit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Total Video Limit
                            </label>
                            <input
                                type="number"
                                name="total_video_limit"
                                id="total_video_limit"
                                value="{{ campaign.config.get('total_video_limit', 3000) }}"
                                min="10"
                                max="50000"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                            >
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Max videos to discover (10-50,000)</p>
                        </div>

                        <div>
                            <label for="per_channel_limit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Per-Channel Limit
                            </label>
                            <input
                                type="number"
                                name="per_channel_limit"
                                id="per_channel_limit"
                                value="{{ campaign.config.get('per_channel_limit', 5) }}"
                                min="1"
                                max="100"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                            >
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Max videos from any single channel</p>
                        </div>

                        <div>
                            <label for="search_limit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Initial Search Limit
                            </label>
                            <input
                                type="number"
                                name="search_limit"
                                id="search_limit"
                                value="{{ campaign.config.get('search_limit', 50) }}"
                                min="10"
                                max="500"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                            >
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Results from initial search</p>
                        </div>

                        <div>
                            <label for="similar_videos_depth" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Similar Videos Depth
                            </label>
                            <input
                                type="number"
                                name="similar_videos_depth"
                                id="similar_videos_depth"
                                value="{{ campaign.config.get('similar_videos_depth', 2) }}"
                                min="0"
                                max="5"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                            >
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Recursion depth for related videos</p>
                        </div>

                        <div>
                            <label for="min_duration_seconds" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Minimum Duration (seconds)
                            </label>
                            <input
                                type="number"
                                name="min_duration_seconds"
                                id="min_duration_seconds"
                                value="{{ campaign.config.get('min_duration_seconds', 60) }}"
                                min="0"
                                max="86400"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                            >
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Default: 60s (filters out Shorts)</p>
                        </div>

                        <div>
                            <label for="max_duration_seconds" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Maximum Duration (seconds)
                            </label>
                            <input
                                type="number"
                                name="max_duration_seconds"
                                id="max_duration_seconds"
                                value="{{ campaign.config.get('max_duration_seconds', 7200) }}"
                                min="0"
                                max="86400"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                            >
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Default: 7200s (2 hours)</p>
                        </div>
                    </div>

                    <div>
                        <label for="filter_threshold" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Relevance Threshold: <span id="threshold-value">{{ campaign.config.get('filter_threshold', 0.7) }}</span>
                        </label>
                        <input
                            type="range"
                            name="filter_threshold"
                            id="filter_threshold"
                            value="{{ campaign.config.get('filter_threshold', 0.7) }}"
                            min="0"
                            max="1"
                            step="0.05"
                            class="mt-2 w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer"
                            oninput="document.getElementById('threshold-value').textContent = this.value"
                        >
                        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                            <span>More results</span>
                            <span>Higher quality</span>
                        </div>
                    </div>
                </div>

                <!-- Enabled Agents (Read-only display) -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-6 space-y-4">
                    <h3 class="text-sm font-medium text-gray-900 dark:text-white uppercase tracking-wider">
                        Enabled Discovery Agents
                    </h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">The following agents are enabled for this campaign:</p>

                    <div class="flex flex-wrap gap-2">
                        {% for agent in campaign.config.get('enabled_agents', ['search', 'channel_expansion', 'topic_filter', 'similar_videos']) %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-primary-100 text-primary-800 dark:bg-primary-900 dark:text-primary-300">
                            {% if agent == 'search' %}
                            <i class="fas fa-search mr-1.5"></i> Search
                            {% elif agent == 'channel_expansion' %}
                            <i class="fas fa-expand-arrows-alt mr-1.5"></i> Channel Expansion
                            {% elif agent == 'topic_filter' %}
                            <i class="fas fa-filter mr-1.5"></i> AI Topic Filter
                            {% elif agent == 'similar_videos' %}
                            <i class="fas fa-clone mr-1.5"></i> Similar Videos
                            {% else %}
                            {{ agent }}
                            {% endif %}
                        </span>
                        {% endfor %}
                    </div>
                </div>

                <!-- Actions -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                    <div class="flex justify-between">
                        <!-- Danger Zone -->
                        <div>
                            <button
                                type="button"
                                class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                                onclick="confirmDelete()"
                            >
                                <i class="fas fa-trash mr-1"></i> Delete Campaign
                            </button>
                        </div>

                        <div class="flex space-x-3">
                            <a href="/admin/topic-campaigns/{{ campaign.id }}"
                               class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                Cancel
                            </a>
                            <button type="submit"
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                <span id="submit-indicator" class="htmx-indicator mr-2">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                                <i class="fas fa-save mr-1"></i> Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tips -->
    <div class="mt-6 bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-lightbulb text-blue-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800 dark:text-blue-300">Tips for better results</h3>
                <div class="mt-2 text-sm text-blue-700 dark:text-blue-400">
                    <ul class="list-disc pl-5 space-y-1">
                        <li>Use specific, descriptive topics for more relevant results</li>
                        <li>Start with a lower video limit and increase if needed</li>
                        <li>A lower per-channel limit ensures diversity across creators</li>
                        <li>Higher relevance threshold means fewer but more targeted videos</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-800">
        <div class="mt-3">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
            </div>
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Delete Campaign</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        Are you sure you want to delete this campaign? This will permanently remove:
                    </p>
                    <ul class="mt-2 text-sm text-gray-500 dark:text-gray-400 text-left">
                        <li>- All discovered videos</li>
                        <li>- All discovered channels</li>
                        <li>- All agent run history</li>
                        <li>- All campaign statistics</li>
                    </ul>
                    <p class="mt-2 text-sm text-red-600 dark:text-red-400">
                        This action cannot be undone.
                    </p>
                </div>
                <div class="items-center px-4 py-3 space-x-2">
                    <button
                        id="confirm-delete"
                        class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500"
                        hx-delete="/admin/topic-campaigns/{{ campaign.id }}"
                    >
                        Delete Campaign
                    </button>
                    <button
                        id="cancel-delete"
                        class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-900 dark:text-white text-base font-medium rounded-md shadow-sm hover:bg-gray-400 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-500"
                        onclick="hideDeleteModal()"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function confirmDelete() {
    document.getElementById('delete-modal').classList.remove('hidden');
}

function hideDeleteModal() {
    document.getElementById('delete-modal').classList.add('hidden');
}

document.addEventListener('DOMContentLoaded', function() {
    // Handle HTMX error responses
    document.body.addEventListener('htmx:responseError', function(event) {
        const xhr = event.detail.xhr;
        let message = 'An error occurred';
        try {
            const response = JSON.parse(xhr.responseText);
            message = response.detail || message;
        } catch (e) {
            message = xhr.responseText || message;
        }
        showToast(message, 'error');
    });

    // Close modal when clicking outside
    document.getElementById('delete-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideDeleteModal();
        }
    });
});
</script>
{% endblock %}
